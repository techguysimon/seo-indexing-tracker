{% if feedback %}<p class="feedback">{{ feedback }}</p>{% endif %}

<section class="panel">
  <h2>Website details</h2>
  <ul class="data-list">
    <li>
      <strong>{{ website.domain }}</strong>
      <span>{{ website.site_url }}</span>
      <span>Quota status: <strong>{{ quota_status.status }}</strong></span>
      <span>Indexing quota: {{ quota_status.indexing.used }} / {{ quota_status.indexing.limit }} (confidence: {{ "%.0f" | format(quota_status.confidence * 100) }}%)</span>
      <div class="bar-track quota-track" role="img" aria-label="Indexing quota usage progress">
        <div class="bar-fill quota-indexing" style="--bar: {{ "%.2f" | format((quota_status.indexing.used / quota_status.indexing.limit * 100) if quota_status.indexing.limit > 0 else 0) }}%;"></div>
      </div>
      <span>Inspection quota: {{ quota_status.inspection.used }} / {{ quota_status.inspection.limit }} (confidence: {{ "%.0f" | format(quota_status.confidence * 100) }}%)</span>
      <div class="bar-track quota-track" role="img" aria-label="Inspection quota usage progress">
        <div class="bar-fill quota-inspection" style="--bar: {{ "%.2f" | format((quota_status.inspection.used / quota_status.inspection.limit * 100) if quota_status.inspection.limit > 0 else 0) }}%;"></div>
      </div>
      <form
        class="inline-form"
        action="/ui/websites/{{ website.id }}/quota/discover"
        method="post"
        hx-post="/ui/websites/{{ website.id }}/quota/discover"
        hx-target="#website-detail-region"
        hx-swap="innerHTML"
      >
        <button type="submit" class="panel-button panel-button-small">Test quota</button>
      </form>
      <span>Indexed URLs: {{ index_stats.indexed_count }}</span>
      <span>Not indexed URLs: {{ index_stats.not_indexed_count }}</span>
      <span>Coverage: {{ index_stats.coverage_percentage }}%</span>
      <a class="panel-button panel-button-ghost" href="/ui/websites/{{ website.id }}/urls">View URL drill-down</a>
    </li>
  </ul>
</section>

<section class="panel">
  <h2>Service account</h2>
  {% if service_account %}
  <ul class="data-list">
    <li>
      <strong>{{ service_account.name }}</strong>
      <span>{{ service_account.credentials_path }}</span>
      <span>Scopes: {{ service_account.scopes | join(", ") }}</span>
      <form
        class="inline-form"
        action="/ui/websites/{{ website.id }}/service-account/delete"
        method="post"
        hx-post="/ui/websites/{{ website.id }}/service-account/delete"
        hx-target="#website-detail-region"
        hx-swap="innerHTML"
      >
        <button
          type="submit"
          class="panel-button panel-button-danger panel-button-small"
          onclick="return confirm('Delete this service account?')"
        >
          Delete service account
        </button>
      </form>
    </li>
  </ul>
  {% else %}
  <p>Not configured yet.</p>
  <form
    class="filter-grid"
    action="/ui/websites/{{ website.id }}/service-account"
    method="post"
    hx-post="/ui/websites/{{ website.id }}/service-account"
    hx-target="#website-detail-region"
    hx-swap="innerHTML"
  >
    <label>
      Name
      <input type="text" name="name" required placeholder="Production Service Account" />
    </label>
    <label>
      Credentials path
      <input
        type="text"
        name="credentials_path"
        required
        placeholder="/app/service-accounts/website-service-account.json"
      />
    </label>
    <label class="checkbox-wrap">
      <input type="checkbox" name="scopes" value="indexing" checked />
      Indexing scope
    </label>
    <label class="checkbox-wrap">
      <input type="checkbox" name="scopes" value="webmasters" checked />
      Webmasters scope
    </label>
    <button type="submit" class="panel-button">Save service account</button>
  </form>
  {% endif %}
</section>

<section class="panel">
  <h2>Sitemaps</h2>
  <form
    class="filter-grid"
    action="/ui/websites/{{ website.id }}/sitemaps"
    method="post"
    hx-post="/ui/websites/{{ website.id }}/sitemaps"
    hx-target="#website-detail-region"
    hx-swap="innerHTML"
  >
    <label>
      Sitemap URL
      <input type="url" name="url" required placeholder="https://example.com/sitemap.xml" />
    </label>
    <label>
      Sitemap type
      <select name="sitemap_type" required>
        {% for sitemap_type in sitemap_types %}
        <option value="{{ sitemap_type }}">{{ sitemap_type }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit" class="panel-button">Add sitemap</button>
  </form>

  <ul class="data-list">
    {% for sitemap in sitemaps %}
    {%- set progress = sitemap_progress.get(sitemap.id) -%}
    <li>
      <strong>{{ sitemap.url }}</strong>
      <span>Type: {{ sitemap.sitemap_type.value }}</span>
      <span class="pill {% if sitemap.is_active %}pill-ok{% else %}pill-dim{% endif %}">
        {% if sitemap.is_active %}Active{% else %}Inactive{% endif %}
      </span>
      
      {%- if progress -%}
      {%- if progress.status == "complete" -%}
      <span class="pill pill-success">✓ complete</span>
      {%- elif progress.status == "error" -%}
      <span class="pill pill-danger" {% if progress.errors %}title="{{ progress.errors }}"{% endif %}>✗ error{% if progress.errors %}: {{ progress.errors[:50] }}{% if progress.errors|length > 50 %}...{% endif %}{% endif %}</span>
      {%- elif progress.status in ("fetching", "parsing", "discovering") -%}
      <span class="pill pill-info"><span class="spinner"></span> {{ progress.status }}</span>
      {%- else -%}
      <span class="pill pill-dim">{{ progress.status }}</span>
      {%- endif -%}
      
      {%- if progress.status == "complete" and progress.urls_found > 0 -%}
      <span class="text-muted">URLs: {{ "{:,}".format(progress.urls_found) }} ({{ "{:,}".format(progress.urls_new) }} new, {{ "{:,}".format(progress.urls_modified) }} modified)</span>
      {%- endif -%}
      
      <span class="text-muted">Last refresh: {{ progress.updated_at|datetime_relative }}</span>
      {%- else -%}
      <span class="pill pill-dim">Not refreshed</span>
      {%- endif -%}
      
      <form
        class="inline-form"
        action="/ui/sitemaps/{{ sitemap.id }}/delete"
        method="post"
        hx-post="/ui/sitemaps/{{ sitemap.id }}/delete"
        hx-target="#website-detail-region"
        hx-swap="innerHTML"
      >
        <button
          type="submit"
          class="panel-button panel-button-danger panel-button-small"
          onclick="return confirm('Delete this sitemap?')"
        >
          Delete sitemap
        </button>
      </form>
    </li>
    {% else %}
    <li>No sitemaps configured yet.</li>
    {% endfor %}
  </ul>
</section>

<section class="panel">
  <h2>Trigger indexing</h2>
  <p>Run sitemap discovery and enqueue all discovered URLs for this website.</p>
  <form
    action="/ui/websites/{{ website.id }}/trigger"
    method="post"
    hx-post="/ui/websites/{{ website.id }}/trigger"
    hx-target="#website-detail-region"
    hx-swap="innerHTML"
  >
    <button type="submit" class="panel-button">Trigger indexing</button>
  </form>
</section>
